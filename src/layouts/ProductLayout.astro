---
import { getCollection, render } from "astro:content";
import type { CollectionEntry } from "astro:content";

import BaseLayout from "./BaseLayout.astro";
import ProductHero from "../components/product/ProductHero.astro";
import FeatureSection from "../components/product/FeatureSection.astro";
import ApplicationSection from "../components/product/ApplicationSection.astro";
import SpecificationSection from "../components/product/SpecificationSection.astro";
import RelatedProducts from "../components/product/RelatedProducts.astro";

type ProductEntry = CollectionEntry<"products">;

interface Props {
  product: ProductEntry;
}

const { product }: Props = Astro.props;
const { data } = product;

const pageTitle = data.seoTitle ?? `${data.title} | Might Print`;
const pageDescription = data.seoDescription ?? data.description;
const { Content } = await render(product);

const allProducts = await getCollection("products");
const relatedProducts = allProducts.filter(
  (p) => p.slug !== product.slug && p.data.category === data.category
);

const features = data.features ?? [];
const applications = data.applications ?? [];
const technicalSpecs = data.technicalSpecs ?? [];
const materials = data.materials ?? [];

const overviewText =
  data.overview ??
  "Built for retail visibility and production efficiency, this product is optimized for real-world packaging workflows and scalable production.";

const visuals = [
  {
    src: "https://placehold.co/1200x800/f3f8ff/1d4368?text=Product+View+01",
    alt: `${data.title} retail presentation`,
  },
  {
    src: "https://placehold.co/1200x800/f8fbff/1d4368?text=Product+View+02",
    alt: `${data.title} structure detail`,
  },
  {
    src: "https://placehold.co/1200x800/f4f9ff/1d4368?text=Product+View+03",
    alt: `${data.title} production view`,
  },
];
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <ProductHero title={data.title} description={data.description} heroImage={data.heroImage} />

  <section class="section intro-strip">
    <div class="container">
      <div class="intro-single">
        <article class="intro-card">
          <span class="kicker">Product Overview</span>
          <h2>{data.title}</h2>
          <p>{overviewText}</p>
        </article>
      </div>
    </div>
  </section>

  <section class="section visual-compact">
    <div class="container">
      <div class="visual-grid">
        {visuals.map((img) => (
          <figure>
            <img src={img.src} alt={img.alt} loading="lazy" />
          </figure>
        ))}
      </div>
    </div>
  </section>

  {features.length > 0 && <FeatureSection features={features} />}

  {(technicalSpecs.length > 0 || materials.length > 0 || data.moq || data.leadTime) && (
    <SpecificationSection
      technicalSpecs={technicalSpecs}
      materials={materials}
      moq={data.moq}
      leadTime={data.leadTime}
    />
  )}

  {applications.length > 0 && (
    <ApplicationSection applications={applications} />
  )}

  <section class="section product-body">
    <div class="container">
      <div class="content-card">
        <div class="prose article-prose content-narrow">
          <Content />
        </div>
      </div>
    </div>
  </section>

  {relatedProducts.length > 0 && <RelatedProducts products={relatedProducts} />}

  <section class="section">
    <div class="container">
      <div class="cta">
        <h2>Need Custom Packaging Solutions?</h2>
        <p>
          Share your product details and we will suggest the right structure,
          material, and printing plan.
        </p>
        <a href="/contact" class="btn-primary">Request a Quote</a>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
.intro-strip {
  margin-top: 0;
}

.intro-single {
  max-width: 820px;
}

.intro-card,
.content-card {
  background: #fff;
  border: 1px solid #e8edf3;
  border-radius: 12px;
  padding: 22px;
}

.kicker {
  display: inline-block;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #6d7a88;
  margin-bottom: 8px;
}

.intro-card h2 {
  margin: 0 0 10px;
}

.intro-card p {
  margin: 0;
  color: var(--color-muted);
  line-height: 1.75;
}

.visual-compact {
  margin-top: 0;
}

.visual-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

.visual-grid figure {
  margin: 0;
  border: 1px solid #e8edf3;
  border-radius: 10px;
  overflow: hidden;
  background: #fff;
}

.visual-grid img {
  width: 100%;
  aspect-ratio: 16 / 10;
  object-fit: cover;
  display: block;
}

.product-body {
  margin-top: 0;
}

.content-card {
  padding: 26px;
}

.article-prose :global(h2) {
  margin: 2rem 0 0.7rem;
  padding: 0.65rem 0.9rem;
  background: #f3f8ff;
  border-left: 3px solid #b7d5f6;
  border-radius: 8px;
  color: #16324d;
}

.article-prose :global(h3) {
  margin: 1.4rem 0 0.6rem;
  color: #1f3d5a;
}

.article-prose :global(p),
.article-prose :global(li) {
  line-height: 1.8;
  color: #3f5367;
}

.article-prose :global(ul),
.article-prose :global(ol) {
  padding-left: 1.25rem;
}

.article-prose :global(li) {
  margin-bottom: 0.4rem;
}

.article-prose :global(hr) {
  border: 0;
  height: 1px;
  background: linear-gradient(to right, transparent, #d7e3f0, transparent);
  margin: 1.4rem 0;
}

@media (max-width: 980px) {
  .visual-grid {
    grid-template-columns: 1fr;
  }

  .content-card {
    padding: 18px;
  }
}
</style>
